{{ define "main" }}
{{/*
  WG Section layout with auto-detection of nested content.
  - If this section has wgID param: render full WG root page
  - If parent section has wgID param: auto-detect as wg-content and render accordingly
*/}}
{{- $isWGRoot := .Params.wgID -}}
{{- $parentWG := "" -}}
{{- if not $isWGRoot -}}
  {{- range .Ancestors -}}
    {{- if and (not $parentWG) .Params.wgID -}}
      {{- $parentWG = . -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- $isNestedContent := and (not $isWGRoot) $parentWG -}}

{{/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     AUTO-DETECTED WG-CONTENT RENDERING (nested deliverable sections)
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}}
{{ if $isNestedContent }}
  {{ partial "wg-sub-navigation.html" . }}

{{ else }}
{{/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     REGULAR WG ROOT RENDERING (wgID detected)
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}}
{{- $wgID := .Params.wgID | upper -}}
{{- $color := .Params.color | default "green" -}}
{{- $cardGrads := dict
  "blue"   "135deg, #08152e, #0d2452"
  "green"  "135deg, #0a1f14, #0d3d24"
  "orange" "135deg, #1e0c05, #3d1a08"
  "purple" "135deg, #110820, #2a0d3d"
  "teal"   "135deg, #051d1d, #0b3838"
  "red"    "135deg, #200808, #3d0d0d"
-}}
{{- $cardGrad := index $cardGrads $color | default "135deg, #0a1f14, #0d3d24" -}}

{{/* Hero */}}
{{ partial "hero.html" . }}

{{/* WG colour accent strip */}}
<div class="wg-hero-strip wg-{{ .Params.wgID | lower }}"></div>

{{/* â”€â”€ Sticky in-page section nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}}
{{- $focusPage       := .GetPage "focus" -}}
{{- $delivPage       := .GetPage "deliverables" -}}
{{- $membersSubPage  := .GetPage "members" -}}
{{- $resourcesPage   := .GetPage "resources" -}}
{{- $confPage        := .GetPage "conferences" -}}
{{- $charterPage     := .GetPage "charter" -}}
<nav class="wg-section-nav wg-{{ .Params.wgID | lower }}" id="wgSectionNav" aria-label="Page sections">
  <div class="container d-flex gap-1">
    {{ if or .Params.intro .Content .Params.chair }}
    <a class="wg-nav-link is-active" href="{{ .RelPermalink }}">About</a>
    {{ end }}
    {{ if .Params.keyDeliverables }}
    <a class="wg-nav-link" data-target="wg-key-deliverables" href="#wg-key-deliverables">Deliverables</a>
    {{ end }}
    {{ if $charterPage }}
    <a class="wg-nav-link" href="{{ $charterPage.RelPermalink }}">Charter</a>
    {{ end }}
    {{ if .Params.focus }}
    {{ if $focusPage }}
    <a class="wg-nav-link" href="{{ $focusPage.RelPermalink }}">Focus Areas</a>
    {{ else }}
    <a class="wg-nav-link" data-target="wg-focus" href="#wg-focus">Focus Areas</a>
    {{ end }}
    {{ end }}
    {{- if .Params.deliverables -}}
    {{- $base := .RelPermalink -}}
    {{- $hasDelivLink := false -}}
    {{- range .Params.deliverables -}}
      {{- $delURL := .url | default "" -}}
      {{- if and $delURL (strings.HasPrefix $delURL $base) -}}
        {{- $hasDelivLink = true -}}
        {{- $label := .menuTitle | default (.title | truncate 22 "â€¦") -}}
        {{- $delSection := $.Site.GetPage $delURL -}}
        {{- $delHasChildren := and $delSection (or $delSection.Sections $delSection.RegularPages) -}}
        {{- $slug := $delURL | strings.TrimPrefix "/" | strings.TrimSuffix "/" | replaceRE "/" "-" -}}
        {{- if $delHasChildren -}}
        <div class="wg-nav-link-wrap" data-panel="wg-nav-tree-{{ $slug }}">
          <a class="wg-nav-link" href="{{ $delURL }}">{{ $label }}</a>
          <button class="wg-nav-more-btn" type="button"
                  data-wg-tree-btn aria-expanded="false" aria-label="Show contents">
            <svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24"
                 fill="none" stroke="currentColor" stroke-width="2.5"
                 stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </button>
        </div>
        {{- else -}}
        <a class="wg-nav-link" href="{{ $delURL }}">{{ $label }}</a>
        {{- end -}}
      {{- end -}}
    {{- end -}}
    {{- if not $hasDelivLink -}}
      {{ if $delivPage }}
      <a class="wg-nav-link" href="{{ $delivPage.RelPermalink }}">Deliverables</a>
      {{ else }}
      <a class="wg-nav-link" data-target="wg-deliverables" href="#wg-deliverables">Deliverables</a>
      {{ end }}
    {{- end -}}
    {{- end -}}
    {{ if $wgID }}
    {{ if $membersSubPage }}
    <a class="wg-nav-link" href="{{ $membersSubPage.RelPermalink }}">Members</a>
    {{ else }}
    <a class="wg-nav-link" data-target="wg-members" href="#wg-members">Members</a>
    {{ end }}
    {{ end }}
    {{ if .Params.resources }}
    {{ if $resourcesPage }}
    <a class="wg-nav-link" href="{{ $resourcesPage.RelPermalink }}">Resources</a>
    {{ else }}
    <a class="wg-nav-link" data-target="wg-resources" href="#wg-resources">Resources</a>
    {{ end }}
    {{ end }}
    {{ if $confPage }}
    <a class="wg-nav-link" href="{{ $confPage.RelPermalink }}">Conferences</a>
    {{ end }}
    <a class="wg-nav-link" href="/blog/?wg={{ .Params.wgID | lower }}">Blog</a>
  </div>
</nav>

{{/* Tree panels â€” one per deliverable section with child pages */}}
{{- $wgBase := .RelPermalink -}}
{{- range .Params.deliverables -}}
  {{- $delURL := .url | default "" -}}
  {{- if and $delURL (strings.HasPrefix $delURL $wgBase) -}}
    {{- $delSection := $.Site.GetPage $delURL -}}
    {{- if and $delSection (or $delSection.Sections $delSection.RegularPages) -}}
      {{- $slug := $delURL | strings.TrimPrefix "/" | strings.TrimSuffix "/" | replaceRE "/" "-" -}}
<div class="wg-nav-tree-panel wg-{{ $.Page.Params.wgID | lower }}" id="wg-nav-tree-{{ $slug }}" hidden>
  {{ partial "wg-sidebar-tree.html" $delSection }}
</div>
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/* Intro + CTA â€” only when there's something meaningful to show */}}
{{ if or .Params.intro .Content .Params.chair }}
<section class="py-5" id="wg-about">
  <div class="container">
    <div class="row align-items-start g-4">
      <div class="col-lg-8">
        {{ with .Params.intro }}
          <p class="lead fs-5">{{ . | markdownify }}</p>
        {{ end }}
        {{ .Content }}
      </div>
      <div class="col-lg-4">
        {{ with .Params.chair }}
        <div class="wg-leadership-label">Working Group Leadership</div>
        <div class="consortium-leaders">
          {{ partial "leader-card.html" (dict "name" .name "role" (printf "%s Chair" $wgID) "color" $color "affiliation" .affiliation) }}
          {{ with .viceChair }}
          {{ partial "leader-card.html" (dict "name" . "role" (printf "%s Vice Chair" $wgID) "color" $color) }}
          {{ end }}
        </div>
        {{ end }}
        {{ with .Params.chairs }}
        <div class="wg-leadership-label">Working Group Leadership</div>
        <div class="consortium-leaders">
          {{ range . }}
          {{ partial "leader-card.html" (dict "name" .name "role" (printf "%s %s" $wgID (.role | default "Chair")) "color" $color "affiliation" .affiliation) }}
          {{ end }}
        </div>
        {{ end }}
        <div class="mt-3 text-center">
        {{ with $.Param "heroButton" }}
        <a href="{{ $.Param "heroButton.link" }}" class="btn btn-page-accent btn-lg rounded-pill px-4">
          {{ $.Param "heroButton.label" }}
        </a>
        {{ else }}
        <a href="/join/" class="btn btn-page-accent btn-lg rounded-pill px-4">Join this Working Group</a>
        {{ end }}
        </div>
      </div>
    </div>
  </div>
</section>
{{ end }}

{{/* â”€â”€ Key Deliverables â€” prominently featured primary WG outputs â”€â”€â”€â”€ */}}
{{ with .Params.keyDeliverables }}
<section class="wg-key-deliverables py-5" id="wg-key-deliverables">
  <div class="container">
    <div class="text-center mb-5">
      <p class="wg-key-eyebrow">Key Deliverables</p>
    </div>
    <div class="row g-4 justify-content-center">
      {{ range . }}
      <div class="col-md-6 col-lg-5">
        <div class="wg-key-card wg-key-card--{{ $color }}">
          {{ with .badge }}<span class="badge wg-key-badge">{{ . }}</span>{{ end }}
          <div class="wg-key-icon">
            {{ partial "wg-icon.html" (dict "id" .icon "class" "wg-key-svg") }}
          </div>
          <h3 class="wg-key-title">{{ .title }}</h3>
          <p class="wg-key-desc">{{ .description }}</p>
          <a href="{{ .url }}" class="wg-key-cta">{{ .cta | default "Learn More" }} â†’</a>
        </div>
      </div>
      {{ end }}
    </div>
  </div>
</section>
{{ end }}

{{/* â”€â”€ Explore sub-pages grid OR inline fallback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}}
{{ if or $focusPage $delivPage $membersSubPage $resourcesPage }}

{{/* Sub-page preview grid */}}
<section class="py-5 wg-alt-section" id="wg-explore">
  <div class="container">
    <h2 class="fw-bold mb-1">Explore this Working Group</h2>
    <p class="text-muted mb-4">Select a section to dive deeper</p>
    <div class="row g-3">
      {{ if and $focusPage .Params.focus }}
      <div class="col-sm-6 col-lg-3">
        <a href="{{ $focusPage.RelPermalink }}" class="wg-explore-card wg-explore-card--{{ $color }} h-100 d-flex flex-column text-decoration-none">
          <div class="wg-explore-icon">ğŸ¯</div>
          <div class="wg-explore-title">Focus Areas</div>
          <div class="wg-explore-desc">{{ len .Params.focus }} active focus areas</div>
          <div class="wg-explore-arrow mt-auto">Explore â†’</div>
        </a>
      </div>
      {{ end }}
      {{ if and $delivPage .Params.deliverables }}
      <div class="col-sm-6 col-lg-3">
        <a href="{{ $delivPage.RelPermalink }}" class="wg-explore-card wg-explore-card--{{ $color }} h-100 d-flex flex-column text-decoration-none">
          <div class="wg-explore-icon">ğŸ“¦</div>
          <div class="wg-explore-title">Deliverables</div>
          <div class="wg-explore-desc">{{ len .Params.deliverables }} deliverables and work items</div>
          <div class="wg-explore-arrow mt-auto">Explore â†’</div>
        </a>
      </div>
      {{ end }}
      {{ if $membersSubPage }}
      {{- $wgMemberCount := 0 -}}
      {{- range hugo.Data.members -}}{{- if in .workingGroups $wgID -}}{{- $wgMemberCount = add $wgMemberCount 1 -}}{{- end -}}{{- end -}}
      <div class="col-sm-6 col-lg-3">
        <a href="{{ $membersSubPage.RelPermalink }}" class="wg-explore-card wg-explore-card--{{ $color }} h-100 d-flex flex-column text-decoration-none">
          <div class="wg-explore-icon">ğŸ¢</div>
          <div class="wg-explore-title">Members</div>
          <div class="wg-explore-desc">{{ $wgMemberCount }} participating organizations</div>
          <div class="wg-explore-arrow mt-auto">Explore â†’</div>
        </a>
      </div>
      {{ end }}
      {{ if and $resourcesPage .Params.resources }}
      <div class="col-sm-6 col-lg-3">
        <a href="{{ $resourcesPage.RelPermalink }}" class="wg-explore-card wg-explore-card--{{ $color }} h-100 d-flex flex-column text-decoration-none">
          <div class="wg-explore-icon">ğŸ“š</div>
          <div class="wg-explore-title">Resources</div>
          <div class="wg-explore-desc">{{ len .Params.resources }} curated resources</div>
          <div class="wg-explore-arrow mt-auto">Explore â†’</div>
        </a>
      </div>
      {{ end }}
    </div>
  </div>
</section>

{{ else }}

{{/* â”€â”€ Inline fallback sections (for WGs without sub-pages) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}}

{{/* Focus Areas */}}
{{ with .Params.focus }}
<section class="py-5 wg-alt-section" id="wg-focus">
  <div class="container">
    <h2 class="fw-bold mb-1">Focus Areas</h2>
    <p class="text-muted mb-4">What this working group focuses on</p>
    <div class="bento-grid">
      {{ range . }}
      <div class="bento-card bento-{{ $color }}-pale">
        {{ with .icon }}<span class="bento-icon">{{ . }}</span>{{ end }}
        <div class="bento-title">{{ .title }}</div>
        <div class="bento-text">{{ .description }}</div>
      </div>
      {{ end }}
    </div>
  </div>
</section>
{{ end }}

{{/* Current Deliverables / Work items */}}
{{ with .Params.deliverables }}
<section class="py-5" id="wg-deliverables">
  <div class="container">
    <h2 class="fw-bold mb-1">What We're Working On</h2>
    <p class="text-muted mb-4">Current and planned deliverables of this working group</p>
    <div class="bento-grid">
      {{ range . }}
      <div class="bento-card">
        <span class="bento-badge bg-{{ if eq .status "active" }}success{{ else if eq .status "planned" }}warning text-dark{{ else }}info{{ end }}">
          {{ .status | default "active" }}
        </span>
        <div class="bento-title">{{ .title }}</div>
        <div class="bento-text">{{ .description }}</div>
        {{ with .url }}
        <div class="bento-footer">
          <a href="{{ . }}" class="stretched-link text-decoration-none text-success fw-semibold">Explore â†’</a>
        </div>
        {{ end }}
      </div>
      {{ end }}
    </div>
  </div>
</section>
{{ end }}

{{/* Members in this WG */}}
{{ with $wgID }}
<section class="py-5" id="wg-members">
  <div class="container">
    <h2 class="fw-bold mb-1">Working Group Members</h2>
    <p class="text-muted mb-4">Organizations actively participating in the {{ $.Title }}</p>
    <div class="members-grid">
      {{- $wgMembers := slice -}}
      {{- range hugo.Data.members -}}
        {{- if in .workingGroups $wgID -}}
          {{- $wgMembers = $wgMembers | append . -}}
        {{- end -}}
      {{- end -}}
      {{- range (shuffle $wgMembers) -}}
        {{- partial "member-card.html" (dict "member" . "site" $.Site "showDescription" false "showWorkingGroups" false "showSocialHover" true) -}}
      {{- end -}}
    </div>
    <div class="text-center mt-4">
      <a href="/members/" class="btn btn-outline-success rounded-pill">View All Members</a>
    </div>
  </div>
</section>
{{ end }}

{{/* Resources */}}
{{ with .Params.resources }}
<section class="py-5" id="wg-resources">
  <div class="container">
    <h2 class="fw-bold mb-1">Industry Resources</h2>
    <p class="text-muted mb-4">Useful references and external resources</p>
    <div class="bento-grid">
      {{ range . }}
      <a class="bento-card bento-card-link text-decoration-none" href="{{ .url }}" target="_blank" rel="noopener noreferrer">
        <div class="bento-title">{{ .title }}</div>
        <div class="bento-text">{{ .description }}</div>
        <div class="bento-footer text-success">Visit â†—</div>
      </a>
      {{ end }}
    </div>
  </div>
</section>
{{ end }}

{{ end }}{{/* end if sub-pages / fallback */}}

{{/* â”€â”€ Recent blog posts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}}
{{ $blogPages := where .Site.RegularPages "Type" "blog" }}
{{ $wgTag := .Params.wgID | lower }}
{{ $relatedPosts := slice }}
{{ range $blogPages }}
  {{ $tags := .Params.tags | default slice }}
  {{ if in $tags $wgTag }}
    {{ $relatedPosts = $relatedPosts | append . }}
  {{ end }}
{{ end }}
{{ if gt (len $relatedPosts) 0 }}
<section class="py-5 wg-alt-section" id="wg-blog">
  <div class="container">
    <h2 class="fw-bold mb-4">From the Blog</h2>
    <div class="row g-3">
      {{ range first 3 (sort $relatedPosts "Date" "desc") }}
      <div class="col-md-4">
        {{ partial "pagelisting.html" . }}
      </div>
      {{ end }}
    </div>
    <div class="text-center mt-3">
      <a href="/blog/" class="btn btn-outline-success rounded-pill">More on the Blog</a>
    </div>
  </div>
</section>
{{ end }}

{{/* Sub-pages (charter, etc.) â€” excluding section sub-pages */}}
{{ $otherSubPages := slice }}
{{ range .Data.Pages }}
  {{ if not .Params.wgSection }}
    {{ $otherSubPages = $otherSubPages | append . }}
  {{ end }}
{{ end }}
{{ if $otherSubPages }}
<section class="py-4">
  <div class="container">
    <h3 class="fw-bold mb-3">More from this Working Group</h3>
    <div class="row g-3">
      {{ range $otherSubPages }}
      <div class="col-sm-6 col-md-4">
        <a href="{{ .Permalink }}" class="bento-card bento-card-link d-block text-decoration-none" style="min-height:120px;">
          <div class="bento-title">{{ .Title }}</div>
          <div class="bento-text">{{ .Summary }}</div>
        </a>
      </div>
      {{ end }}
    </div>
  </div>
</section>
{{ end }}{{/* Join CTA */}}
<section class="py-5">
  <div class="container">
    <div class="pkic-cta-block bento-{{ $color }} text-white">
      <div class="pkic-cta-title">Join the {{ .Title }}</div>
      <p class="pkic-cta-text">
        {{- if eq .Params.wgID "CA" -}}
        Membership in the CA Working Group is currently limited to publicly trusted CAs only (Category A members).
        {{- else -}}
        Membership in the PKI Consortium working groups is open to all member types.
        {{- end -}}
        Collaborate with industry leaders, shape standards, and drive meaningful change.
      </p>
      <a href="/join/" class="btn btn-light btn-lg rounded-pill px-5 fw-bold">Become a Member</a>
      <a href="/discussions/" class="btn btn-outline-light btn-lg rounded-pill px-4 ms-2">Join Discussions</a>
    </div>
  </div>
</section>

{{ $wgNavJS := resources.Get "js/wg-nav.js" | minify | fingerprint }}
<script src="{{ $wgNavJS.RelPermalink }}" defer></script>

{{ end }}{{/* end if $isNestedContent / else regular WG root */}}

{{ end }}{{/* end define "main" */}}
