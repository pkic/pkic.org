{{- $member := .member -}}
{{- $site := .site -}}
{{- $showDescription := .showDescription | default true -}}
{{- $showWorkingGroups := .showWorkingGroups | default true -}}
{{- $showSocialHover := .showSocialHover | default false -}}

{{- /* ── Sponsor level lookup ───────────────────────────────────────── */ -}}
{{- $sponsorLevel := 0 -}}
{{- $sponsorLevelName := "" -}}
{{- with $member.sponsor -}}
  {{- with .level -}}
    {{- $l := index hugo.Data.sponsorlevels . -}}
    {{- if $l -}}{{- $sponsorLevel = $l -}}{{- $sponsorLevelName = . -}}{{- end -}}
  {{- end -}}
  {{- with (index .sponsoring $site.Params.name) -}}
    {{- $l := index hugo.Data.sponsorlevels .level -}}
    {{- if $l -}}{{- if gt $l $sponsorLevel -}}
      {{- $sponsorLevel = $l -}}{{- $sponsorLevelName = .level -}}
    {{- end -}}{{- end -}}
  {{- end -}}
{{- end -}}

{{- $memberPage := $site.GetPage (printf "/members/%s" $member.id) -}}
{{- if not $memberPage -}}
  {{- $memberPage = $site.GetPage (printf "/members-data/%s" $member.id) -}}
{{- end -}}

{{- $href := $member.website -}}
{{- $external := true -}}
{{- with $memberPage -}}
  {{- $href = .Permalink -}}
  {{- $external = false -}}
{{- end -}}

{{- /* stretched-link: the <div> is the grid item; <a> inside uses position:absolute to cover it */ -}}
<div class="member-card bento-card" data-member-name="{{ lower $member.name }}">
  <a class="stretched-link" href="{{ $href }}" {{ if $external }}target="_blank" rel="noopener"{{ end }} aria-label="{{ $member.name }}"></a>
  {{- $img := resources.GetMatch (printf "/images/members/%s/%s.*" $member.id $member.id) -}}
  <div class="member-card-logo-wrap">
  {{- with $img -}}
    <img class="member-card-logo" src="{{ .Permalink }}" alt="{{ $member.name }} logo" loading="lazy" />
  {{- else -}}
    {{- $words := split $member.name " " -}}
    {{- $initials := "" -}}
    {{- range $i, $w := first 3 $words -}}
      {{- $clean := replaceRE "[^a-zA-Z]" "" $w -}}
      {{- if $clean -}}{{- $initials = printf "%s%s" $initials (strings.ToUpper (substr $clean 0 1)) -}}{{- end -}}
    {{- end -}}
    {{- $colorIdx := mod (len $member.name) 6 -}}
    <div class="member-card-initials initial-color-{{ $colorIdx }}">{{ $initials }}</div>
  {{- end -}}
  </div>

  <div class="member-card-name">{{ $member.name }}</div>
  {{- if $showDescription -}}
    {{- with $member.slogan -}}<div class="member-card-slogan">{{ . }}</div>{{- end -}}
    {{- with $member.description -}}<p class="member-card-description">{{ . | plainify | truncate 160 }}</p>{{- end -}}
  {{- end -}}

  {{- if $showWorkingGroups -}}
    {{- $wg := $member.workingGroups -}}
    {{- with $wg -}}
    <div class="member-card-wgs" style="position:relative;z-index:2;">
      {{- if eq (printf "%T" .) "[]interface {}" -}}
        {{- range . -}}<span class="wg-tag">{{ . }}</span>{{- end -}}
      {{- else -}}
        <span class="wg-tag">{{ . }}</span>
      {{- end -}}
    </div>
    {{- end -}}
  {{- end -}}

  {{- if and $showSocialHover $member.social -}}
    <div class="member-card-social" style="position:relative;z-index:2;">{{ partial "social.html" $member.social }}</div>
  {{- end -}}

  {{- if gt $sponsorLevel 0 -}}
    <div class="member-card-sponsor-footer sponsor-tier-{{ $sponsorLevel }}" style="position:relative;z-index:2;">{{ $sponsorLevelName }} Sponsor</div>
  {{- end -}}
</div>