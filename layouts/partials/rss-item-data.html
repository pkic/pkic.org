{{- $feedURLStr := . -}}
{{- $items := slice -}}

{{- /* Skip remote RSS fetches to speed up local development.
       This is controlled via (in order of precedence):
       1. Env var:  HUGO_SKIP_REMOTE_FEEDS=true hugo server
       2. Env var:  HUGO_PARAMS_SKIPREMOTEFEEDS=true hugo server  (auto-maps to params)
       3. config/development/params.yaml  →  skipRemoteFeeds: true
          - Applied automatically by `hugo server` (defaults to environment=development)
          - For hugo build use: hugo build -e development
       4. config.yaml  →  params.skipRemoteFeeds: true  (affects all builds/envs) */ -}}
{{- $skip := or (eq (os.Getenv "HUGO_SKIP_REMOTE_FEEDS") "true") (eq (os.Getenv "HUGO_SKIP_REMOTE_FEEDS") "1") -}}
{{- if site.Params.skipRemoteFeeds -}}
  {{- $skip = true -}}
{{- end -}}

{{- if not $skip -}}

{{- $timeout := "5s" -}}
{{- if hugo.IsServer -}}
  {{- $timeout = "1s" -}}
{{- end -}}

{{- $feedURL := urls.Parse $feedURLStr -}}
{{- $remote := try (resources.GetRemote $feedURLStr (dict "timeout" $timeout)) -}}

{{- if $remote.Err -}}
  {{- if not hugo.IsServer -}}
    {{- warnf "Error fetching remote feed %q: %s" $feedURLStr $remote.Err -}}
  {{- end -}}
{{- else -}}
  {{- with $remote.Value -}}
    {{- if or (strings.HasSuffix .MediaType "rss+xml") (strings.HasSuffix .MediaType "atom+xml") (strings.HasSuffix .MediaType "xml") -}}
      {{- $unmarshaled := try (transform.Unmarshal .Content) -}}
      {{- if $unmarshaled.Err -}}
        {{- warnf "Error unmarshaling feed %q: %s" $feedURLStr $unmarshaled.Err -}}
      {{- else -}}
        {{- $feedItems := slice -}}
        {{- if index $unmarshaled.Value "channel" -}}
          {{- $feedItems = $unmarshaled.Value.channel.item -}}
        {{- else if index $unmarshaled.Value "entry" -}}
           {{- $feedItems = $unmarshaled.Value.entry -}}
        {{- end -}}
        {{- with $feedItems -}}
          {{- if eq (printf "%T" .) "[]interface {}" -}}
            {{- range first 10 . -}}
              {{- $newItem := dict -}}
              {{- range $k, $v := . -}}
                {{- if eq $k "pubDate" -}}
                  {{- $timeValue := try (time $v) -}}
                  {{- if not $timeValue.Err -}}
                    {{- $newItem = merge $newItem (dict $k $timeValue.Value) -}}
                  {{- end -}}
                {{- else if or (eq $k "published") (eq $k "updated") -}}
                  {{- $timeValue := try (time $v) -}}
                  {{- if not $timeValue.Err -}}
                    {{- $newItem = merge $newItem (dict "pubDate" $timeValue.Value) -}}
                  {{- end -}}
                {{- else if eq $k "link" -}}
                  {{- if hasPrefix $v "/" -}}
                    {{- $v = printf "https://%s%s" $feedURL.Host $v -}}
                  {{- end -}}
                  {{- $newItem = merge $newItem (dict $k $v) -}}
                {{- else -}}
                  {{- $newItem = merge $newItem (dict $k $v) -}}
                {{- end -}}
              {{- end -}}
              {{- if index $newItem "pubDate" -}}
                {{- $items = $items | append $newItem -}}
              {{- end -}}
            {{- end -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- end -}}
{{- return $items -}}
