{{ $level := "all" }}
{{ with $.Scratch.Get "level" }}
    {{ $level = . }}
{{ end }}

{{ $sponsoring := $.Site.Params.name }}
{{ with $.Scratch.Get "sponsoring" }}
    {{ $sponsoring = . }}
{{ end }}

{{ $sponsors := slice }}

<!-- member sponsors -->
{{ range $.Site.Data.members }}
    {{ if or 
        (and (eq $level "all") (gt .sponsor.level ""))
        (eq .sponsor.level $level)
        (index .sponsor.sponsoring $sponsoring)
    }}

        {{ $sponsors = $sponsors | append . }}
    {{ end }}
{{ end }}

<!-- non-member sponsors -->
{{ range $.Site.Data.sponsors }}
    {{ if or 
        (and (eq $level "all") (gt .sponsor.level ""))
        (eq .sponsor.level $level)
        (index .sponsor.sponsoring $sponsoring)
    }}

        {{ $sponsors = $sponsors | append . }}
    {{ end }}
{{ end }}

<div class="sponsors">
{{ if gt (len $sponsors) 0 }}
        {{ range (shuffle $sponsors) }}
            {{ $context := $.Site.Params.name }}
            {{ $level := .sponsor.level }}
            {{ with (index .sponsor.sponsoring $sponsoring) }}
                {{ $level = .level }}
                {{ $context = $sponsoring }}
            {{ end }}

            {{ $title := (printf "%s is a %s sponsor for the %s" .name $level $sponsoring ) }}
            <a href="{{ .website }}" title="{{ $title }}" target="_blank">
                {{ $img := resources.GetMatch (printf "/images/**/%s/%s.*" .id .id) }}
                {{ if .logo }}
                    {{ $img = resources.GetMatch (printf "/images/sponsors/**/%s" .logo) }}
                {{ end }}

                {{ with $img}}
                <img style="{{ with $.Scratch.Get `max-height` }}max-height: {{ . }}px;{{ end }}{{ with $.Scratch.Get `max-width` }}max-width: {{ . }}px;{{ end }}{{ with $.Scratch.Get `height` }}height: {{ . }}px;{{ end }}" class="sponsor-logo{{ with $.Scratch.Get `class` }} {{ . }}{{ end }}" alt="{{ $title }}" title="{{ $title }}" src="{{ $img.Permalink }}">
                {{ end }}
            </a>
        {{ end }}
{{ end }}
</div>